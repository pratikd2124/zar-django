{% extends 'dashboard/template.html' %}
{% block content %}
<style>
    .chartWrapper {
        position: relative;
      }
      
      .chartWrapper > canvas {
        position: absolute;
        left: 0;
        top: 0;
        pointer-events: none;
      }
      
      .chartAreaWrapper {
        height: 1500px;
        overflow-y: scroll;
      }
</style>
            <!-- index body start -->
            <div class="page-body">
                <div class="container-fluid">
                    <div class="row">
                        <!-- chart caard section start -->
                        <div class="col-sm-6 col-xxl-3 col-lg-6">
                            <div class="main-tiles border-5 border-0  card-hover card o-hidden">
                                <div class="custome-1-bg b-r-4 card-body">
                                    <div class="media align-items-center static-top-widget">
                                        <div class="media-body p-0">
                                            <span class="m-0">Users</span>
                                            <h4 class="mb-0 counter"> {{Home_Owner_count}}
                                             
                                            </h4>
                                        </div>
                                        <div class="align-self-center text-center">
                                            <i class="ri-database-2-line"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-sm-6 col-xxl-3 col-lg-6">
                            <div class="main-tiles border-5 card-hover border-0 card o-hidden">
                                <div class="custome-2-bg b-r-4 card-body">
                                    <div class="media static-top-widget">
                                        <div class="media-body p-0">
                                            <span class="m-0"> No. Categories </span>
                                            <h4 class="mb-0 counter">{{categories.count}}
                                               
                                            </h4>
                                        </div>
                                        <div class="align-self-center text-center">
                                            <i class="ri-shopping-bag-3-line"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-sm-6 col-xxl-3 col-lg-6">
                            <div class="main-tiles border-5 card-hover border-0 card o-hidden">
                                <div class="custome-4-bg b-r-4 card-body">
                                    <div class="media static-top-widget">
                                        <div class="media-body p-0">
                                            <span class="m-0">Sevice providers</span>
                                            <h4 class="mb-0 counter">{{Service_Provider_count}}
                                             
                                            </h4>
                                        </div>

                                        <div class="align-self-center text-center">
                                            <i class="ri-shopping-bag-3-line"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-sm-6 col-xxl-3 col-lg-6">
                            <div class="main-tiles border-5 card-hover border-0  card o-hidden">
                                <div class="custome-3-bg b-r-4 card-body">
                                    <div class="media static-top-widget">
                                        <div class="media-body p-0">
                                            <span class="m-0">Total Brands</span>
                                            <h4 class="mb-0 counter">{{material_provider_count}}
                                               
                                            </h4>
                                        </div>

                                        <div class="align-self-center text-center">
                                            <i class="ri-chat-3-line"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-4 mb-2">
                            
                        </div>

                     <!-- Recent orders start-->
                     <div class="col-xl-12">
                        <div class="card o-hidden card-hover">
                            <div class="card-header card-header-top card-header--2 px-0 pt-0">
                                <div class="card-header-title d-flex" style="align-items: center;">
                                    <h4 >Category Visits Chart</h4>
                                    <button type="button" class="btn btn-primary" onclick="window.location.reload()" >Reset</button>
                                </div>
                                
                                <!-- Filter buttons -->
                                <div class="btn-group" role="group" aria-label="Sort Buttons">
                                    <button id="top10" class="btn btn-primary">Top 10</button>
                                    <button id="top20" class="btn btn-primary">Top 20</button>
                                    <button id="top30" class="btn btn-primary">Top 30</button>
                                    <button id="low10" class="btn btn-secondary">Lowest 10</button>
                                    <button id="low20" class="btn btn-secondary">Lowest 20</button>
                                    <button id="low30" class="btn btn-secondary">Lowest 30</button>
                                </div>
                            </div>
                    
                            <div class="card-body p-0 chartWrapper">
                                <div id="report" class="chartAreaWrapper"> <!-- Scrollable Container -->
                                    <canvas id="categoryVisitsChart" height="1500" width="100"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Recent orders end-->


                        <!-- Earning chart star-->
                        <div class="col-xl-6">
                            <div class="card o-hidden card-hover">
                                <div class="card-header border-0 pb-1">
                                    <div class="card-header-title">
                                        <h4>Weekly Active Users</h4>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div id="report">
                                        <canvas id="weeklyActiveUsersChart" style="width:100%;max-width:"></canvas>

                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Earning chart  end-->


                        <!-- Best Selling Product Start -->
                        <div class="col-xl-6 col-md-12">
                            <div class="card o-hidden card-hover">
                                <div class="card-header card-header-top card-header--2 px-0 pt-0">
                                    <div class="card-header-title">
                                        <h4>Monthly Active Users Chart</h4>
                                    </div>

                            
                                </div>

                                <div class="card-body p-0">
                                    <div id="report">
                                        <canvas id="monthlyActiveUsersChart" style="width:100%;max-width:"></canvas>

                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-6 col-md-12">
                            <div class="card o-hidden card-hover">
                                <div class="card-header card-header-top card-header--2 px-0 pt-0">
                                    <div class="card-header-title">
                                        <h4>Country  Wise</h4>
                                    </div>

                            
                                </div>

                                <div class="card-body p-0">
                                    <div id="report">
                                        <canvas id="countryWise" style="width:100%;max-width:"></canvas>

                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Best Selling Product End -->


                        

                    

                   


                    </div>
                    
                </div>
                <!-- Container-fluid Ends-->

                <!-- footer start-->
                 
                <!-- footer End-->
            </div>
            <!-- index body end -->

            <script>
                console.log({{ country_wise_users_count|safe }});
                console.log({{ category_wise_visited_users_count|safe }});
            
                const lastWeekActiveUsers = JSON.parse('{{ last_week_active_users_list|safe }}');
                const monthly_active_users = JSON.parse('{{ monthly_active_users|safe }}');
                const country_wise_users_count = JSON.parse('{{ country_wise_users_count|safe }}');
            
                // Weekly Active Data
                const weeklyActiveData = {
                    labels: Object.keys(lastWeekActiveUsers), // Get the days (keys) for labels
                    datasets: [{
                        label: 'Active Users',
                        data: Object.values(lastWeekActiveUsers), // Get the user counts (values) for data points
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                };
            
                // Monthly Active Data
                const monthlyActiveData = {
                    labels: Object.keys(monthly_active_users), // Directly use the passed list
                    datasets: [{
                        label: 'Active Users',
                        data: Object.values(monthly_active_users), // Directly use the passed list
                        backgroundColor: 'rgba(153, 102, 255, 0.6)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                };
            


                const catcountryData = {
                    labels: Object.keys(country_wise_users_count),  // Labels on Y-axis
                    datasets: [{
                        label: 'Visits',
                        data: Object.values(country_wise_users_count),  // Data on X-axis
                        backgroundColor: 'rgba(255, 159, 64, 0.6)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    }]
                };
            
                function createChart(ctx, data, title, isHorizontal = false) {
                    new Chart(ctx, {
                        type: 'bar',
                        data: data,
                        options: {
                            indexAxis: isHorizontal ? 'y' : 'x',  // Switch to horizontal if necessary
                            responsive: true,
                            maintainAspectRatio: true,  // Allow chart height to adjust dynamically
                            scales: {
                                x: {
                                    beginAtZero: true
                                },
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        autoSkip: false  // Ensure all labels are displayed
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                title: {
                                    display: true,
                                    text: title
                                }
                            }
                        }
                    });
                }
            
                // Initialize charts on window load
                window.onload = function() {

                    const weeklyCtx = document.getElementById('weeklyActiveUsersChart').getContext('2d');
                    createChart(weeklyCtx, weeklyActiveData, 'Weekly Active Users');
            
                    const monthlyCtx = document.getElementById('monthlyActiveUsersChart').getContext('2d');
                    createChart(monthlyCtx, monthlyActiveData, 'Monthly Active Users');
            
                    
                    const countryCtx = document.getElementById('countryWise').getContext('2d');
                    createChart(countryCtx, catcountryData, 'Country Wise Users', true);  // Pass 'true' to make it horizontal
                };
            
            </script>
            

            
<script>
    // Simulating the data (you already have this as a Django template variable)
    let categoryWiseVisitedUsersCount = JSON.parse('{{ category_wise_visited_users_count|safe }}');

    // Function to update chart with filtered data
    function updateChart(chart, labels, dataValues) {
        chart.data.labels = labels;
        chart.data.datasets[0].data = dataValues;
        chart.update();
    }

    // Function to sort and filter data based on selection
    function filterData(order, count) {
        const entries = Object.entries(categoryWiseVisitedUsersCount);

        if (order === 'highest') {
            entries.sort((a, b) => b[1] - a[1]); // Sort descending
        } else if (order === 'lowest') {
            entries.sort((a, b) => a[1] - b[1]); // Sort ascending
        }

        const filteredEntries = entries.slice(0, count); // Get top/bottom 'count' items
        return {
            labels: filteredEntries.map(entry => entry[0]), // Category paths
            data: filteredEntries.map(entry => entry[1])    // Visit counts
        };
    }

    // Initial data for chart (full data by default)
    const initialData = filterData('highest', Object.keys(categoryWiseVisitedUsersCount).length);
    const ctx = document.getElementById('categoryVisitsChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: initialData.labels,
            datasets: [{
                label: 'Number of Visits',
                data: initialData.data,
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        autoSkip: false,
                        font: {
                            size: function(context) {
                                const numLabels = initialData.labels.length;
                                return numLabels > 10 ? 10 : 14;
                            }
                        }
                    }
                },
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Visits'
                    }
                }
            },
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    enabled: true,
                }
            },
            layout: {
                padding: {
                    top: 20,
                    bottom: 20,
                    left: 20,
                    right: 20
                }
            }
        }
    });

    // Event listeners for buttons
    document.getElementById('top10').addEventListener('click', function () {
        const sortedData = filterData('highest', 10);
        updateChart(chart, sortedData.labels, sortedData.data);
    });

    document.getElementById('top20').addEventListener('click', function () {
        const sortedData = filterData('highest', 20);
        updateChart(chart, sortedData.labels, sortedData.data);
    });

    document.getElementById('top30').addEventListener('click', function () {
        const sortedData = filterData('highest', 30);
        updateChart(chart, sortedData.labels, sortedData.data);
    });

    document.getElementById('low10').addEventListener('click', function () {
        const sortedData = filterData('lowest', 10);
        updateChart(chart, sortedData.labels, sortedData.data);
    });

    document.getElementById('low20').addEventListener('click', function () {
        const sortedData = filterData('lowest', 20);
        updateChart(chart, sortedData.labels, sortedData.data);
    });

    document.getElementById('low30').addEventListener('click', function () {
        const sortedData = filterData('lowest', 30);
        updateChart(chart, sortedData.labels, sortedData.data);
    });
</script>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

            {% endblock content %}
       